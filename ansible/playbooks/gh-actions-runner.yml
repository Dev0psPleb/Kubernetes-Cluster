---
- hosts: masters
  gather_facts: true
  connection: local
  vars:
    KUBECONFIG: ../.kube/config
    ansible_python_interpreter: '{{ ansible_playbook_python }}'
    APP_ID: 181998
    INSTALLATION_ID: 24232027
    PRIVATE_KEY_FILE_PATH: ../secrets/gh-self-hoster-runners.2022-03-18.private-key.pem

  tasks:
    - name: Download Certmanager manifest
      ansible.builtin.get_url:
        url: https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.yaml
        dest: ../kubernetes/cert-manager.yaml
        mode: '0664'

    - name: Download Kubernetes Github Actions Runner Controller definition
      ansible.builtin.get_url:
        url: https://github.com/actions-runner-controller/actions-runner-controller/releases/download/v0.22.0/actions-runner-controller.yaml
        dest: ../kubernetes/actions-runner-controller.yaml
        mode: '0664'

    - name: Deploy Cert Manager
      kubernetes.core.k8s:
        src: '../kubernetes/cert-manager.yaml'
        kubeconfig: '../.kube/config'
        state: present

    - name: Deploy Github Actions Runner Controller
      kubernetes.core.k8s:
        src: '../kubernetes/actions-runner-controller.yaml'
        kubeconfig: '../.kube/config'
        state: present
    
    - name: Create Generic Secret
      kubernetes.core.k8s:
        state: present
        kubeconfig: '../.kube/config'
        definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: controller-manager
            namespace: actions-runner-system
          type: Opaque
          data:
            github_app_id: '{{ APP_ID | b64encode }}'
            github_app_installation_id: '{{ INSTALLATION_ID | b64encode }}'
            github_app_private_key: '{{ PRIVATE_KEY_FILE_PATH | b64encode }}'
    
    - name: Runner Deployment
      kubernetes.core.k8s:
        state: present
        kubeconfig: '{{ KUBECONFIG }}'
        definition:
          apiVersion: actions.summerwind.dev/v1alpha1
          kind: RunnerDeployment
          metadata:
            name: runner-deployment
            namespace: actions-runner-system
          spec:
            template:
              labels:
                app: github
              spec:
                repository: RalphBrynard/vsphere-packer-builds
    
    - name: Horizontal Runner Autoscaler
      kubernetes.core.k8s:
        state: present
        kubeconfig: '{{ KUBECONFIG }}'
        definition:
          apiVersion: actions.summerwind.dev/v1alpha1
          kind: HorizontalRunnerAutoscaler
          metadata:
            name: runner-deployment
            namespace: actions-runner-system
          spec:
            scaleTargetRef:
              name: runner-deployment
            minReplicas: 1
            maxReplicas: 5
            metrics:
              - type: TotalNumberofQueuedAndInProgressWorkflowRuns
                repositoryNames:
                - RalphBrynard/vsphere-packer-builds




